#!/usr/bin/env bash
#
# The 'compile' script is executed by the slug compiler with three arguments:
#
# - $1: build_dir, location of your app directory on the build dyno
# - $2: cache_dir, directory on the build dyno that persists between builds
# - $3: env_dir, directory holding all the app's config vars as files
#
# More information here: https://devcenter.heroku.com/articles/buildpack-api
#------------------------------------------------------------------------------#

set -euo pipefail

# debug
# set -x

# clean up leaking environment
unset GIT_DIR

function log() {
    echo "-----> $*"
}

function indent() {
    sed -e 's/^/       /'
}

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
BUILDPACK_DIR="$(dirname "$(dirname "$0")")"

apt-get update && apt-get install -y cmake libdbus-1-dev libdbus-glib-1-dev libcurl4-openssl-dev libgcrypt20-dev libselinux1-dev libxslt1-dev libgconf2-dev libacl1-dev libblkid-dev libcap-dev libxml2-dev libldap2-dev libpcre3-dev python-dev-is-python3 swig libxml-parser-perl libxml-xpath-perl libperl-dev libbz2-dev librpm-dev g++ libyaml-dev libxmlsec1-dev libxmlsec1-openssl libpcre2-dev

# replace ${version} with the desired version
wget https://github.com/OpenSCAP/openscap/releases/download/1.3.10/openscap-1.3.10.tar.gz
tar -xzpf openscap-1.3.10.tar.gz
cd openscap-1.3.10
mkdir -p build
cd build/

hash -r
log "cmake $(cmake --version)"
cmake ../
log "make"
make
log "make install"
make install
